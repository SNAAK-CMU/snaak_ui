{% load static %}
{% load get_item %}
<!DOCTYPE html>
<html>

<head>
    <title>User Page</title>
    <link rel="stylesheet" href="{% static 'main/style.css' %}">
    <style>
        .center-btn {
            display: flex;
            justify-content: center;
            margin-top: 24px;
        }

        .disabled {
            background: #e0e0e0 !important;
            color: #888 !important;
            pointer-events: none;
        }

        .ingredient-row input:disabled {
            background: #f3f3f3;
            color: #aaa;
        }
    </style>
    <script>
        // Store ingredient data for calorie calculations
        const ingredientData = {
            ingredients: [
                {% for ingredient in ingredients %}
                {
                    name: "{{ ingredient.name }}",
                    calories: {{ ingredient.calories|default:0 }},
                    type: "{{ ingredient.type }}"
                },
                {% endfor %}
            ],
            bread: [
                {% for ingredient in bread_ingredients %}
                {
                    name: "{{ ingredient.name }}",
                    calories: {{ ingredient.calories|default:0 }}
                },
                {% endfor %}
            ]
        };

        function calculateTotalCalories() {
            let totalCalories = 0;

            // Add bread calories (2 slices)
            const breadType = document.querySelector('input[name="bread_type"]:checked');
            if (breadType) {
                const breadItem = ingredientData.bread.find(b => b.name === breadType.value);
                if (breadItem) {
                    totalCalories += breadItem.calories * 2;
                }
            }

            // Add ingredient calories
            const ingredientRows = document.querySelectorAll('.ingredient-row');
            ingredientRows.forEach(row => {
                const label = row.querySelector('label[data-name]');
                const input = row.querySelector('input[type="number"]');
                if (label && input) {
                    const ingredientName = label.getAttribute('data-name');
                    const quantity = parseInt(input.value) || 0;
                    const ingredientItem = ingredientData.ingredients.find(i => i.name === ingredientName);
                    if (ingredientItem && quantity > 0) {
                        totalCalories += ingredientItem.calories * quantity;
                    }
                }
            });

            // Update the display
            const calorieDisplay = document.getElementById('total-calories-display');
            if (calorieDisplay) {
                calorieDisplay.textContent = Math.round(totalCalories);
            }
        }

        function startRecipe() {
            // Prevent submission if button is disabled
            const btn = document.getElementById('start-recipe-btn');
            if (btn.disabled) {
                return false;
            }
            
            const ingredientRows = document.querySelectorAll('.ingredient-row');
            let recipe = {};
            // Get bread type
            const breadType = document.querySelector('input[name="bread_type"]:checked');
            if (breadType) {
                recipe[breadType.value] = 2;
            }
            ingredientRows.forEach(row => {
                const label = row.querySelector('label[data-name]');
                const input = row.querySelector('input[type="number"]');
                if (label && input) {
                    recipe[label.getAttribute('data-name')] = parseInt(input.value) || 0;
                }
            });
            fetch("", {
                method: "POST",
                headers: { "Content-Type": "application/json", 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify(recipe)
            })
                .then(resp => resp.json())
                .then(data => {
                    if (data.status === "success") {
                        alert("Starting Recipe!");
                    } else {
                        alert("Error saving recipe.");
                    }
                })
                .catch(() => alert("Error saving recipe."));
            return false;
        }

        function fetchFSMState() {
            fetch('/fsm_state/')
                .then(response => response.json())
                .then(data => {
                    let box = document.getElementById('fsm-state-box');
                    let form = document.getElementById('recipe-form');
                    let btn = document.getElementById('start-recipe-btn');
                    let inputs = form.querySelectorAll('input[type="number"]');
                    if (data.fsm_state !== 'Recipe') {
                        // Gray out if not recipe
                        if (data.fsm_state === 'Fail') {
                            box.innerHTML = '<div style="color:#fff;background:#d32f2f;font-weight:bold;padding:16px 0;border-radius:8px;font-size:1.2em;">Fail State. Contact Operator.</div>';
                        } else if (data.fsm_state) {
                            box.innerHTML = '<div style="color:#155724;background:#d4edda;border:1px solid #c3e6cb;padding:16px 0;border-radius:8px;font-weight:bold;font-size:1.1em;">Sandwich In Progress... (Current State: <b>' + data.fsm_state + '</b>)</div>';
                        } else {
                            box.innerHTML = '<div style="color:#856404;background:#fff3cd;border:1px solid #ffeeba;padding:16px 0;border-radius:8px;font-weight:bold;font-size:1.1em;">System Initializing... Please wait.</div>';
                        }
                        btn.classList.add('disabled');
                        btn.disabled = true;
                        inputs.forEach(input => input.disabled = true);
                    } else {
                        // In Recipe state - clear state box, check restock before enabling
                        box.innerHTML = '';
                        updateButtonState();
                    }
                });
        }

        function fetchRestockWarning() {
            fetch('/restock_check_api/')
                .then(response => response.json())
                .then(data => {
                    let banner = document.getElementById('restock-warning-banner');
                    
                    if (data.show_warning) {
                        // Show warning and disable button
                        banner.style.display = '';
                        banner.textContent = data.message || 'Restock is necessary. Please contact an operator.';
                    } else {
                        // Hide warning
                        banner.style.display = 'none';
                    }
                    updateButtonState();
                });
        }

        function updateButtonState() {
            // This function enables button only if BOTH conditions are met:
            // 1. FSM is in Recipe state
            // 2. No restock warning is showing
            fetch('/fsm_state/')
                .then(response => response.json())
                .then(stateData => {
                    fetch('/restock_check_api/')
                        .then(response => response.json())
                        .then(restockData => {
                            let btn = document.getElementById('start-recipe-btn');
                            let form = document.getElementById('recipe-form');
                            let inputs = form.querySelectorAll('input[type="number"]');
                            
                            const inRecipeState = stateData.fsm_state === 'Recipe';
                            const needsRestock = restockData.show_warning === true;
                            
                            if (inRecipeState && !needsRestock) {
                                // Both conditions met - enable button
                                btn.classList.remove('disabled');
                                btn.disabled = false;
                                inputs.forEach(input => input.disabled = false);
                            } else {
                                // Either condition not met - disable button
                                btn.classList.add('disabled');
                                btn.disabled = true;
                                inputs.forEach(input => input.disabled = true);
                            }
                        });
                });
        }

        setInterval(fetchFSMState, 2000);
        setInterval(fetchRestockWarning, 2000);
        fetchFSMState();
        fetchRestockWarning();

        // Initialize calorie display and add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            calculateTotalCalories();

            // Add listeners to all number inputs
            const ingredientRows = document.querySelectorAll('.ingredient-row');
            ingredientRows.forEach(row => {
                const input = row.querySelector('input[type="number"]');
                if (input) {
                    input.addEventListener('change', calculateTotalCalories);
                    input.addEventListener('input', calculateTotalCalories);
                }
            });

            // Add listeners to bread type radio buttons
            const breadRadios = document.querySelectorAll('input[name="bread_type"]');
            breadRadios.forEach(radio => {
                radio.addEventListener('change', calculateTotalCalories);
            });
        });
    </script>
</head>

<body>
    <div class="header">
        <img src="{% static 'main/snaak_logo.png' %}" class="logo" alt="Snaak Logo">
        <div>
            <a href="{% url 'operator_page' %}"><button>Operator Page</button></a>
        </div>
    </div>
    <div class="container">
        <div id="restock-warning-banner" style="display:none;background:#ffdddd;color:#b71c1c;padding:16px;border-radius:8px;margin-bottom:24px;font-weight:bold;text-align:center;">
            Restock is necessary. Please contact an operator.
        </div>
        <h1>Build Your Sandwich</h1>
        {% if error %}<div style="color: red;">{{ error }}</div>{% endif %}
        <div id="fsm-state-box" style="margin-bottom:16px;"></div>
        <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin-bottom: 24px; text-align: center;">
            <p style="margin: 0; font-size: 0.95em; color: #666;">Total Calories</p>
            <p style="margin: 8px 0 0 0; font-size: 1.8em; font-weight: bold; color: #1976d2;">
                <span id="total-calories-display">0</span> cal
            </p>
        </div>
        <form id="recipe-form" onsubmit="return startRecipe();">
            {% csrf_token %}
            {% for ingredient in ingredients %}
                {% if ingredient.type != 'bread' %}
                <div class="ingredient-row">
                    <label data-name="{{ ingredient.name }}">{{ ingredient.name }} {% if ingredient.type == 'shredded' %}(Servings available: {{ ingredient.available }}){% else %}(Available: {{ ingredient.available }}){% endif %}</label>
                    <input type="number" min="0" max="3" value="{{ recipe|get_item:ingredient.name|default:0 }}">
                </div>
                {% endif %}
            {% endfor %}
            {% with bread_types=ingredients|dictsort:"name" %}
            {% if bread_ingredients %}
            <div class="ingredient-row">
                <label>Bread Type:</label>
                {% for ingredient in bread_ingredients %}
                    {% if ingredient.available|default:0 >= 2 %}
                        <label style="margin-right:16px;">
                            <input type="radio" name="bread_type" value="{{ ingredient.name }}" {% if forloop.first %}checked{% endif %}> {{ ingredient.name }} (Available: {{ ingredient.available }})
                        </label>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}
            <div class="center-btn">
                <button id="start-recipe-btn" type="submit" style="background: #1976d2;">Start Recipe</button>
            </div>
        </form>
    </div>
</body>

</html>